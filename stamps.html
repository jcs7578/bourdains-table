<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Passport Stamps â€” Eat Like Anthony</title>
  <meta name="description" content="Every country Anthony Bourdain visited, displayed as passport stamps. Check off restaurants you've been to.">

  <!-- App CSS -->
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

  <!-- ============ NAV ============ -->
  <nav class="site-nav">
    <a href="index.html" class="nav-link">Map</a>
    <a href="stamps.html" class="nav-link active">Passport</a>
    <a href="dishes.html" class="nav-link">Dishes</a>
    <a href="about.html" class="nav-link">About</a>
  </nav>

  <!-- ============ HEADER ============ -->
  <header class="site-header">
    <h1 class="site-title">Your Passport</h1>
    <p class="site-subtitle">"Walk in someone else's shoes â€” or at least eat their food."</p>
    <div class="stamps-stats">
      <span class="stat-item" id="stat-countries"></span>
      <span class="stat-divider">/</span>
      <span class="stat-item" id="stat-restaurants"></span>
      <span class="stat-divider">/</span>
      <span class="stat-item" id="stat-shows"></span>
    </div>
  </header>

  <!-- ============ MAIN ============ -->
  <main class="stamps-content">

    <!-- Personal passport controls -->
    <div class="passport-controls">
      <span class="passport-progress" id="passport-progress"></span>
      <button class="btn-clear-passport" id="btn-clear">Clear All</button>
    </div>
    <p style="text-align:center; font-family: var(--font-mono); font-size: 0.7rem; color: var(--ink-light); margin-bottom: 1rem; opacity: 0.7;">
      Click a stamp to check off restaurants you've visited
    </p>

    <div class="passport-book">
      <div class="passport-page-header">
        <span class="passport-page-label">VISAS &amp; ENTRY STAMPS</span>
        <span class="passport-page-label">VISAS ET CACHETS D'ENTR&Eacute;E</span>
      </div>
      <div id="stamps-grid" class="stamps-grid">
        <!-- Rendered by JS -->
      </div>
    </div>
  </main>

  <!-- ============ MODAL ============ -->
  <div id="stamp-modal" class="stamp-modal" hidden>
    <div class="stamp-modal-backdrop"></div>
    <div class="stamp-modal-content">
      <button class="stamp-modal-close" id="modal-close">&times;</button>
      <div class="stamp-modal-header">
        <span class="stamp-modal-icon" id="modal-icon"></span>
        <h2 class="stamp-modal-title" id="modal-title"></h2>
        <span class="stamp-modal-progress" id="modal-progress"></span>
      </div>
      <div class="stamp-modal-list" id="modal-list">
        <!-- Rendered by JS -->
      </div>
    </div>
  </div>

  <!-- ============ FOOTER ============ -->
  <footer class="site-footer">
    <p class="footer-quote">"Without experimentation, a willingness to ask questions and try new things, we shall surely become static, repetitive, and moribund."</p>
    <p>Built with Leaflet.js &middot; No frameworks, no fuss.</p>
  </footer>

  <!-- Data -->
  <script src="js/data.js"></script>
  <script>
    (function () {
      'use strict';

      // ---- localStorage for visited restaurants ----
      var STORAGE_KEY = 'eatlikeanthony_visited_restaurants';

      function getVisitedSet() {
        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          return [];
        }
      }

      function saveVisitedSet(arr) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
        } catch (e) {}
      }

      function isRestaurantVisited(name) {
        return getVisitedSet().indexOf(name) !== -1;
      }

      function toggleRestaurant(name) {
        var set = getVisitedSet();
        var idx = set.indexOf(name);
        if (idx === -1) {
          set.push(name);
        } else {
          set.splice(idx, 1);
        }
        saveVisitedSet(set);
        return set;
      }

      // Migrate old country-level data if present
      (function migrateOldData() {
        var oldKey = 'eatlikeanthony_visited';
        try {
          var old = localStorage.getItem(oldKey);
          if (old) localStorage.removeItem(oldKey);
        } catch (e) {}
      })();

      function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }

      // Country stamp ink colors
      var COUNTRY_STAMPS = {
        "Argentina":           { ink: '#4a7a9e', icon: 'ðŸ‡¦ðŸ‡·' },
        "Australia":           { ink: '#1a3a6b', icon: 'ðŸ‡¦ðŸ‡º' },
        "Brazil":              { ink: '#2a7a3b', icon: 'ðŸ‡§ðŸ‡·' },
        "Cambodia":            { ink: '#6b2d4a', icon: 'ðŸ‡°ðŸ‡­' },
        "Canada":              { ink: '#8b2a2a', icon: 'ðŸ‡¨ðŸ‡¦' },
        "China":               { ink: '#a0342a', icon: 'ðŸ‡¨ðŸ‡³' },
        "Colombia":            { ink: '#8a6b1a', icon: 'ðŸ‡¨ðŸ‡´' },
        "Cuba":                { ink: '#2a4a7b', icon: 'ðŸ‡¨ðŸ‡º' },
        "Denmark":             { ink: '#943040', icon: 'ðŸ‡©ðŸ‡°' },
        "Ethiopia":            { ink: '#2a6b3a', icon: 'ðŸ‡ªðŸ‡¹' },
        "France":              { ink: '#1a2a6b', icon: 'ðŸ‡«ðŸ‡·' },
        "Georgia":             { ink: '#8b3a3a', icon: 'ðŸ‡¬ðŸ‡ª' },
        "Greece":              { ink: '#2a4a8b', icon: 'ðŸ‡¬ðŸ‡·' },
        "Hong Kong":           { ink: '#a0342a', icon: 'ðŸ‡­ðŸ‡°' },
        "India":               { ink: '#b06a1a', icon: 'ðŸ‡®ðŸ‡³' },
        "Indonesia":           { ink: '#8b2a2a', icon: 'ðŸ‡®ðŸ‡©' },
        "Iran":                { ink: '#2a6b4a', icon: 'ðŸ‡®ðŸ‡·' },
        "Israel":              { ink: '#1a3a7b', icon: 'ðŸ‡®ðŸ‡±' },
        "Italy":               { ink: '#2a6b3a', icon: 'ðŸ‡®ðŸ‡¹' },
        "Jamaica":             { ink: '#3a6b2a', icon: 'ðŸ‡¯ðŸ‡²' },
        "Japan":               { ink: '#a03030', icon: 'ðŸ‡¯ðŸ‡µ' },
        "Kenya":               { ink: '#3a5a2a', icon: 'ðŸ‡°ðŸ‡ª' },
        "Laos":                { ink: '#2a3a6b', icon: 'ðŸ‡±ðŸ‡¦' },
        "Lebanon":             { ink: '#8b3040', icon: 'ðŸ‡±ðŸ‡§' },
        "Madagascar":          { ink: '#2a5a3a', icon: 'ðŸ‡²ðŸ‡¬' },
        "Malaysia":            { ink: '#1a2a5b', icon: 'ðŸ‡²ðŸ‡¾' },
        "Mexico":              { ink: '#3a5a3a', icon: 'ðŸ‡²ðŸ‡½' },
        "Morocco":             { ink: '#8b3030', icon: 'ðŸ‡²ðŸ‡¦' },
        "Myanmar":             { ink: '#8a7a1a', icon: 'ðŸ‡²ðŸ‡²' },
        "Nigeria":             { ink: '#2a6b3a', icon: 'ðŸ‡³ðŸ‡¬' },
        "Peru":                { ink: '#943030', icon: 'ðŸ‡µðŸ‡ª' },
        "Philippines":         { ink: '#2a4a8b', icon: 'ðŸ‡µðŸ‡­' },
        "Portugal":            { ink: '#2a5a2a', icon: 'ðŸ‡µðŸ‡¹' },
        "Puerto Rico":         { ink: '#3a3a6b', icon: 'ðŸ‡µðŸ‡·' },
        "Senegal":             { ink: '#2a6b3a', icon: 'ðŸ‡¸ðŸ‡³' },
        "Singapore":           { ink: '#8b3040', icon: 'ðŸ‡¸ðŸ‡¬' },
        "South Korea":         { ink: '#1a3a6b', icon: 'ðŸ‡°ðŸ‡·' },
        "Spain":               { ink: '#8b2a1a', icon: 'ðŸ‡ªðŸ‡¸' },
        "Tanzania":            { ink: '#2a6b4a', icon: 'ðŸ‡¹ðŸ‡¿' },
        "Thailand":            { ink: '#6b2a3a', icon: 'ðŸ‡¹ðŸ‡­' },
        "Trinidad and Tobago": { ink: '#8b3030', icon: 'ðŸ‡¹ðŸ‡¹' },
        "Turkey":              { ink: '#a03020', icon: 'ðŸ‡¹ðŸ‡·' },
        "Uganda":              { ink: '#3a3a2a', icon: 'ðŸ‡ºðŸ‡¬' },
        "United Kingdom":      { ink: '#1a2a5b', icon: 'ðŸ‡¬ðŸ‡§' },
        "United States":       { ink: '#2a3a6b', icon: 'ðŸ‡ºðŸ‡¸' },
        "Uruguay":             { ink: '#1a2a7b', icon: 'ðŸ‡ºðŸ‡¾' },
        "Vietnam":             { ink: '#943020', icon: 'ðŸ‡»ðŸ‡³' },
      };
      var DEFAULT_STAMP = { ink: '#5a4d3e', icon: '' };

      // ---- Build country data ----
      var countryData = {};
      var countryRestaurants = {}; // country -> [restaurant objects]
      RESTAURANTS.forEach(function (r) {
        var c = r.country;
        if (!countryData[c]) {
          countryData[c] = { shows: new Set(), count: 0, cities: new Set() };
          countryRestaurants[c] = [];
        }
        countryData[c].count++;
        countryData[c].shows.add(r.show);
        countryData[c].cities.add(r.city);
        countryRestaurants[c].push(r);
      });

      var countries = Object.keys(countryData).sort(function (a, b) {
        return countryData[b].count - countryData[a].count;
      });

      // ---- Helpers ----
      function randRotation() {
        return (Math.random() * 10 - 5).toFixed(1);
      }

      function getCountryProgress(country) {
        var restaurants = countryRestaurants[country] || [];
        var visited = getVisitedSet();
        var checked = 0;
        restaurants.forEach(function (r) {
          if (visited.indexOf(r.name) !== -1) checked++;
        });
        return { checked: checked, total: restaurants.length };
      }

      // ---- Render stamps ----
      var shapes = ['stamp-circle', 'stamp-rect', 'stamp-rounded'];
      var grid = document.getElementById('stamps-grid');

      function renderStamps() {
        var html = '';
        countries.forEach(function (country, idx) {
          var data = countryData[country];
          var stamp = COUNTRY_STAMPS[country] || DEFAULT_STAMP;
          var shape = shapes[idx % shapes.length];
          var rotation = randRotation();
          var progress = getCountryProgress(country);
          var allVisited = progress.checked === progress.total;
          var someVisited = progress.checked > 0;
          var cities = Array.from(data.cities).slice(0, 3).join(' \u2022 ');
          var showList = Array.from(data.shows).map(function (s) {
            return SHOW_MAP[s] ? SHOW_MAP[s].abbr : s;
          }).join(' / ');

          var cls = 'passport-stamp ' + shape;
          if (allVisited) cls += ' visited';
          else if (someVisited) cls += ' partial';

          html += '<div class="' + cls + '"';
          html += ' data-country="' + escapeHtml(country) + '"';
          html += ' style="';
          html += 'transform: rotate(' + rotation + 'deg);';
          html += '--stamp-ink: ' + stamp.ink + ';';
          html += '">';

          // Progress badge
          if (someVisited) {
            html += '<span class="stamp-check">' + progress.checked + '/' + progress.total + '</span>';
          }

          html += '<div class="stamp-icon">' + stamp.icon + '</div>';
          html += '<div class="stamp-country">' + country.toUpperCase() + '</div>';
          html += '<div class="stamp-count">' + progress.checked + ' / ' + progress.total + ' visited</div>';
          html += '<div class="stamp-cities">' + cities + '</div>';
          html += '<div class="stamp-shows">' + showList + '</div>';
          html += '</div>';
        });
        grid.innerHTML = html;
        attachStampClicks();
      }

      // ---- Global progress ----
      var progressEl = document.getElementById('passport-progress');

      function updateProgress() {
        var visited = getVisitedSet();
        var totalRestaurants = RESTAURANTS.length;
        var checkedRestaurants = visited.length;
        var pct = totalRestaurants > 0 ? Math.round((checkedRestaurants / totalRestaurants) * 100) : 0;

        // Count fully completed countries
        var completedCountries = 0;
        countries.forEach(function (c) {
          var p = getCountryProgress(c);
          if (p.checked === p.total) completedCountries++;
        });

        progressEl.innerHTML =
          checkedRestaurants + ' / ' + totalRestaurants + ' restaurants (' + pct + '%) &middot; ' +
          completedCountries + ' / ' + countries.length + ' countries complete' +
          ' <span class="passport-progress-bar"><span class="passport-progress-fill" style="width:' + pct + '%"></span></span>';
      }

      // ---- Modal ----
      var modal = document.getElementById('stamp-modal');
      var modalTitle = document.getElementById('modal-title');
      var modalIcon = document.getElementById('modal-icon');
      var modalProgress = document.getElementById('modal-progress');
      var modalList = document.getElementById('modal-list');
      var modalClose = document.getElementById('modal-close');
      var backdrop = modal.querySelector('.stamp-modal-backdrop');
      var currentModalCountry = null;

      function openModal(country) {
        currentModalCountry = country;
        var stamp = COUNTRY_STAMPS[country] || DEFAULT_STAMP;
        var restaurants = countryRestaurants[country] || [];
        var progress = getCountryProgress(country);

        modalIcon.textContent = stamp.icon;
        modalTitle.textContent = country;
        modalTitle.style.color = stamp.ink;
        updateModalProgress(progress);

        var html = '';
        restaurants.forEach(function (r) {
          var checked = isRestaurantVisited(r.name);
          var loc = r.state ? r.city + ', ' + r.state : r.city;

          html += '<label class="modal-restaurant' + (checked ? ' checked' : '') + '" data-name="' + escapeHtml(r.name) + '">';
          html += '<input type="checkbox"' + (checked ? ' checked' : '') + '>';
          html += '<span class="modal-checkbox-custom"></span>';
          html += '<span class="modal-restaurant-info">';
          html += '<span class="modal-restaurant-name">' + escapeHtml(r.name) + '</span>';
          html += '<span class="modal-restaurant-detail">' + escapeHtml(loc);
          if (r.dish) html += ' &mdash; ' + escapeHtml(r.dish);
          html += '</span>';
          html += '</span>';
          html += '</label>';
        });
        modalList.innerHTML = html;

        // Attach checkbox handlers
        var labels = modalList.querySelectorAll('.modal-restaurant');
        labels.forEach(function (label) {
          var checkbox = label.querySelector('input[type="checkbox"]');
          checkbox.addEventListener('change', function () {
            var name = label.getAttribute('data-name');
            toggleRestaurant(name);
            label.classList.toggle('checked', checkbox.checked);
            var p = getCountryProgress(currentModalCountry);
            updateModalProgress(p);
            updateProgress();
            updateStampAppearance(currentModalCountry);
          });
        });

        modal.hidden = false;
        document.body.style.overflow = 'hidden';
      }

      function updateModalProgress(progress) {
        modalProgress.textContent = progress.checked + ' / ' + progress.total + ' visited';
        if (progress.checked === progress.total) {
          modalProgress.classList.add('complete');
        } else {
          modalProgress.classList.remove('complete');
        }
      }

      function closeModal() {
        modal.hidden = true;
        document.body.style.overflow = '';
        currentModalCountry = null;
      }

      modalClose.addEventListener('click', closeModal);
      backdrop.addEventListener('click', closeModal);
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && !modal.hidden) closeModal();
      });

      // ---- Update individual stamp appearance without full re-render ----
      function updateStampAppearance(country) {
        var stampEl = grid.querySelector('[data-country="' + country + '"]');
        if (!stampEl) return;
        var progress = getCountryProgress(country);
        var allVisited = progress.checked === progress.total;
        var someVisited = progress.checked > 0;

        stampEl.classList.toggle('visited', allVisited);
        stampEl.classList.toggle('partial', someVisited && !allVisited);

        // Update the count text
        var countEl = stampEl.querySelector('.stamp-count');
        if (countEl) countEl.textContent = progress.checked + ' / ' + progress.total + ' visited';

        // Update badge
        var badge = stampEl.querySelector('.stamp-check');
        if (someVisited) {
          if (!badge) {
            badge = document.createElement('span');
            badge.className = 'stamp-check';
            stampEl.insertBefore(badge, stampEl.firstChild);
          }
          badge.textContent = progress.checked + '/' + progress.total;
          badge.style.display = '';
        } else if (badge) {
          badge.style.display = 'none';
        }
      }

      // ---- Attach click handlers to stamps ----
      function attachStampClicks() {
        var stamps = grid.querySelectorAll('.passport-stamp');
        stamps.forEach(function (el) {
          el.addEventListener('click', function () {
            var country = this.getAttribute('data-country');
            openModal(country);
          });
        });
      }

      // ---- Clear all ----
      document.getElementById('btn-clear').addEventListener('click', function () {
        if (!confirm('Clear all visited restaurants?')) return;
        saveVisitedSet([]);
        renderStamps();
        updateProgress();
      });

      // ---- Init ----
      renderStamps();
      updateProgress();

      // Stats
      document.getElementById('stat-countries').textContent = countries.length + ' Countries';
      document.getElementById('stat-restaurants').textContent = RESTAURANTS.length + ' Restaurants';
      document.getElementById('stat-shows').textContent = '4 Shows';
    })();
  </script>

</body>
</html>
